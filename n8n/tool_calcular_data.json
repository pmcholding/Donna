{
  "nodes": [
    {
      "parameters": {
        "name": "Calcular Data",
        "description": "Converte expressoes de data em portugues para data ISO 8601. Use SEMPRE esta ferramenta ANTES de verificar disponibilidade ou criar agendamento. Entrada: expressao como 'segunda', 'amanha', 'proxima terca', 'dia 15', 'semana que vem'. Saida: data no formato YYYY-MM-DD.",
        "jsCode": "// Tool: Calcular Data - Converte expressões de data em português para ISO 8601\n// No toolCode, a variável 'query' contém o input do agente diretamente\nconst expressao = (query || '').toLowerCase().trim();\n\n// Data atual com timezone de Brasília\nconst agora = DateTime.now().setZone('America/Sao_Paulo');\nconst hoje = agora.startOf('day');\n\n// Mapeamento de dias da semana em português\nconst diasSemana = {\n  'domingo': 7,\n  'dom': 7,\n  'segunda': 1,\n  'segunda-feira': 1,\n  'seg': 1,\n  'terca': 2,\n  'terça': 2,\n  'terca-feira': 2,\n  'terça-feira': 2,\n  'ter': 2,\n  'quarta': 3,\n  'quarta-feira': 3,\n  'qua': 3,\n  'quinta': 4,\n  'quinta-feira': 4,\n  'qui': 4,\n  'sexta': 5,\n  'sexta-feira': 5,\n  'sex': 5,\n  'sabado': 6,\n  'sábado': 6,\n  'sab': 6\n};\n\nlet dataCalculada = null;\nlet explicacao = '';\n\n// 1. Hoje\nif (expressao.match(/^hoje$/)) {\n  dataCalculada = hoje;\n  explicacao = 'Hoje';\n}\n\n// 2. Amanhã\nelse if (expressao.match(/^amanh[aã]$/)) {\n  dataCalculada = hoje.plus({ days: 1 });\n  explicacao = 'Amanhã';\n}\n\n// 3. Depois de amanhã\nelse if (expressao.match(/depois\\s*de\\s*amanh[aã]/)) {\n  dataCalculada = hoje.plus({ days: 2 });\n  explicacao = 'Depois de amanhã';\n}\n\n// 4. Dia específico do mês (ex: \"dia 15\", \"15\")\nelse if (expressao.match(/^(?:dia\\s*)?(\\d{1,2})$/)) {\n  const match = expressao.match(/^(?:dia\\s*)?(\\d{1,2})$/);\n  const dia = parseInt(match[1]);\n  let data = hoje.set({ day: dia });\n  \n  // Se o dia já passou neste mês, vai para o próximo mês\n  if (data <= hoje) {\n    data = data.plus({ months: 1 });\n  }\n  dataCalculada = data;\n  explicacao = `Dia ${dia}`;\n}\n\n// 5. Data completa (ex: \"15/12\", \"15/12/2025\")\nelse if (expressao.match(/(\\d{1,2})\\/(\\d{1,2})(?:\\/(\\d{2,4}))?/)) {\n  const match = expressao.match(/(\\d{1,2})\\/(\\d{1,2})(?:\\/(\\d{2,4}))?/);\n  const dia = parseInt(match[1]);\n  const mes = parseInt(match[2]);\n  let ano = match[3] ? parseInt(match[3]) : hoje.year;\n  \n  if (ano < 100) {\n    ano += 2000;\n  }\n  \n  dataCalculada = DateTime.fromObject({ year: ano, month: mes, day: dia }, { zone: 'America/Sao_Paulo' });\n  explicacao = `Data ${dia}/${mes}/${ano}`;\n}\n\n// 6. Dia da semana (ex: \"segunda\", \"próxima terça\")\nelse {\n  const ehProxima = expressao.match(/pr[oó]xim[ao]/i);\n  \n  let diaEncontrado = null;\n  let nomeDia = '';\n  \n  for (const [nome, numero] of Object.entries(diasSemana)) {\n    if (expressao.includes(nome)) {\n      diaEncontrado = numero;\n      nomeDia = nome;\n      break;\n    }\n  }\n  \n  if (diaEncontrado !== null) {\n    const diaAtual = hoje.weekday;\n    let diasParaAdicionar;\n    \n    if (ehProxima) {\n      diasParaAdicionar = (7 - diaAtual) + diaEncontrado;\n    } else {\n      diasParaAdicionar = diaEncontrado - diaAtual;\n      \n      if (diasParaAdicionar <= 0) {\n        diasParaAdicionar += 7;\n      }\n    }\n    \n    dataCalculada = hoje.plus({ days: diasParaAdicionar });\n    explicacao = ehProxima ? `Próxima ${nomeDia}` : `${nomeDia} (próxima ocorrência)`;\n  }\n}\n\n// 7. Semana que vem (mesmo dia da semana)\nif (!dataCalculada && expressao.match(/semana\\s*que\\s*vem/)) {\n  dataCalculada = hoje.plus({ weeks: 1 });\n  explicacao = 'Semana que vem (mesmo dia)';\n}\n\n// 8. Daqui a X dias\nif (!dataCalculada && expressao.match(/daqui\\s*(?:a\\s*)?(\\d+)\\s*dias?/)) {\n  const match = expressao.match(/daqui\\s*(?:a\\s*)?(\\d+)\\s*dias?/);\n  const dias = parseInt(match[1]);\n  dataCalculada = hoje.plus({ days: dias });\n  explicacao = `Daqui a ${dias} dias`;\n}\n\n// Resultado\nconst diasSemanaTexto = ['', 'segunda-feira', 'terça-feira', 'quarta-feira', 'quinta-feira', 'sexta-feira', 'sábado', 'domingo'];\n\nif (dataCalculada) {\n  return `Data calculada com sucesso:\\n- Data ISO: ${dataCalculada.toFormat('yyyy-MM-dd')}\\n- Data formatada: ${dataCalculada.toFormat('dd/MM/yyyy')}\\n- Dia da semana: ${diasSemanaTexto[dataCalculada.weekday]}\\n- Interpretação: ${explicacao}\\n- Data atual: ${hoje.toFormat('dd/MM/yyyy')} (${diasSemanaTexto[hoje.weekday]})`;\n} else {\n  return `Erro: Não foi possível interpretar \"${expressao}\". Use formatos como: \"segunda\", \"amanhã\", \"dia 15\", \"15/12\", \"próxima terça\". Data atual: ${hoje.toFormat('dd/MM/yyyy')} (${diasSemanaTexto[hoje.weekday]})`;\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [
        7584,
        992
      ],
      "id": "calc-data-tool-001",
      "name": "Calcular Data"
    }
  ],
  "connections": {
    "Calcular Data": {
      "ai_tool": [
        [
          {
            "node": "Atendente5",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "0dff2809c326d67264ac89b11c62a81c0e33c81a110b2979fd152608e157400d"
  }
}